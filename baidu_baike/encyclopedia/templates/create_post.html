{% extends 'base.html' %}

{% block title %}发布新帖 - {{ forum.name }} - 百度贴吧{% endblock %}

{% block content %}
<style>
    .CreatePostPage {
        padding: var(--gap-lg) 0;
    }
    
    .CreatePostPage__header {
        background-color: var(--bg-primary);
        border-radius: var(--radius-lg);
        padding: var(--gap-lg);
        margin-bottom: var(--gap-lg);
        box-shadow: var(--shadow-sm);
    }
    
    .CreatePostPage__breadcrumb {
        display: flex;
        align-items: center;
        font-size: 14px;
        color: var(--text-secondary);
        margin-bottom: var(--gap-md);
    }
    
    .CreatePostPage__breadcrumb a {
        color: var(--text-secondary);
        text-decoration: none;
    }
    
    .CreatePostPage__breadcrumb a:hover {
        color: var(--primary);
    }
    
    .CreatePostPage__breadcrumb span {
        margin: 0 var(--gap-xs);
    }
    
    .CreatePostPage__title {
        font-size: 20px;
        color: var(--text-primary);
    }
    
    .CreatePostForm {
        background-color: var(--bg-primary);
        border-radius: var(--radius-lg);
        padding: var(--gap-xl);
        box-shadow: var(--shadow-sm);
    }
    
    .FormSection {
        margin-bottom: var(--gap-xl);
    }
    
    .FormSection:last-child {
        margin-bottom: 0;
    }
    
    .FormSection__title {
        font-size: 16px;
        font-weight: 500;
        color: var(--text-primary);
        margin-bottom: var(--gap-md);
    }
    
    .FormGroup {
        margin-bottom: var(--gap-md);
    }
    
    .FormGroup__label {
        display: block;
        margin-bottom: var(--gap-xs);
        color: var(--text-primary);
        font-weight: 500;
        font-size: 14px;
    }
    
    .FormGroup__input {
        width: 100%;
        padding: var(--gap-sm) var(--gap-md);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 14px;
        outline: none;
        transition: border-color var(--transition-fast);
    }
    
    .FormGroup__input:focus {
        border-color: var(--primary);
    }
    
    .FormGroup__input::placeholder {
        color: var(--text-light);
    }
    
    .FormGroup__error {
        color: var(--danger);
        font-size: 12px;
        margin-top: var(--gap-xs);
    }
    
    .FormGroup__help {
        color: var(--text-light);
        font-size: 12px;
        margin-top: var(--gap-xs);
    }
    
    .EditorToolbar {
        display: flex;
        flex-wrap: wrap;
        gap: var(--gap-xs);
        padding: var(--gap-sm);
        background-color: var(--bg-secondary);
        border: 1px solid var(--border);
        border-bottom: none;
        border-radius: var(--radius-md) var(--radius-md) 0 0;
    }
    
    .EditorToolbar__button {
        padding: var(--gap-xs) var(--gap-sm);
        background-color: transparent;
        border: none;
        border-radius: var(--radius-sm);
        cursor: pointer;
        font-size: 14px;
        color: var(--text-secondary);
        transition: all var(--transition-fast);
        display: flex;
        align-items: center;
        justify-content: center;
        min-width: 32px;
        height: 32px;
    }
    
    .EditorToolbar__button:hover {
        background-color: var(--bg-primary);
        color: var(--text-primary);
    }
    
    .EditorToolbar__button.active {
        background-color: var(--primary);
        color: white;
    }
    
    .EditorToolbar__divider {
        width: 1px;
        background-color: var(--border);
        margin: 0 var(--gap-xs);
    }
    
    .EditorContent {
        width: 100%;
        min-height: 200px;
        padding: var(--gap-md);
        border: 1px solid var(--border);
        border-radius: 0 0 var(--radius-md) var(--radius-md);
        font-size: 14px;
        line-height: 1.6;
        color: var(--text-primary);
        resize: vertical;
        outline: none;
        transition: border-color var(--transition-fast);
    }
    
    .EditorContent:focus {
        border-color: var(--primary);
    }
    
    .EditorContent::placeholder {
        color: var(--text-light);
    }
    
    .ImageUploader {
        border: 2px dashed var(--border);
        border-radius: var(--radius-md);
        padding: var(--gap-xl);
        text-align: center;
        transition: all var(--transition-fast);
        background-color: var(--bg-secondary);
    }
    
    .ImageUploader:hover {
        border-color: var(--primary);
        background-color: rgba(230, 240, 255, 0.3);
    }
    
    .ImageUploader__input {
        display: none;
    }
    
    .ImageUploader__label {
        display: flex;
        flex-direction: column;
        align-items: center;
        cursor: pointer;
        color: var(--text-secondary);
    }
    
    .ImageUploader__icon {
        font-size: 32px;
        margin-bottom: var(--gap-sm);
    }
    
    .ImageUploader__text {
        font-size: 14px;
        margin-bottom: var(--gap-xs);
    }
    
    .ImageUploader__help {
        font-size: 12px;
        color: var(--text-light);
    }
    
    .UploadedImages {
        display: flex;
        flex-wrap: wrap;
        gap: var(--gap-sm);
        margin-top: var(--gap-md);
    }
    
    .UploadedImageItem {
        position: relative;
        width: 100px;
        height: 100px;
        border-radius: var(--radius-sm);
        overflow: hidden;
        background-color: var(--bg-secondary);
    }
    
    .UploadedImageItem img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .UploadedImageItem__remove {
        position: absolute;
        top: var(--gap-xs);
        right: var(--gap-xs);
        width: 24px;
        height: 24px;
        background-color: rgba(0, 0, 0, 0.6);
        border: none;
        border-radius: 50%;
        color: white;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        transition: all var(--transition-fast);
    }
    
    .UploadedImageItem__remove:hover {
        background-color: rgba(0, 0, 0, 0.8);
    }
    
    .CreatePostForm__actions {
        display: flex;
        justify-content: flex-end;
        gap: var(--gap-md);
        padding-top: var(--gap-lg);
        border-top: 1px solid var(--border);
    }
    
    .CreatePostForm__submit {
        padding: var(--gap-sm) var(--gap-lg);
        background-color: var(--primary);
        color: white;
        border: none;
        border-radius: var(--radius-md);
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: background-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    
    .CreatePostForm__submit:hover {
        background-color: var(--primary-hover);
        box-shadow: var(--shadow-md);
    }
    
    .CreatePostForm__cancel {
        padding: var(--gap-sm) var(--gap-lg);
        background-color: transparent;
        color: var(--text-secondary);
        border: 1px solid var(--border);
        border-radius: var(--radius-md);
        font-size: 16px;
        cursor: pointer;
        transition: all var(--transition-fast);
    }
    
    .CreatePostForm__cancel:hover {
        background-color: var(--bg-secondary);
        color: var(--text-primary);
    }
</style>

<div class="Container">
    <div class="CreatePostPage">
        <div class="CreatePostPage__header">
            <div class="CreatePostPage__breadcrumb">
                <a href="/">百度贴吧</a>
                <span>></span>
                <a href="/forum/{{ forum.id }}">{{ forum.name }}</a>
                <span>></span>
                <span>发布新帖</span>
            </div>
            <h1 class="CreatePostPage__title">发布新帖</h1>
        </div>
        
        <form method="post" class="CreatePostForm" enctype="multipart/form-data">
            {% csrf_token %}
            
            <div class="FormSection">
                <div class="FormGroup">
                    <label for="title" class="FormGroup__label">标题 <span style="color: var(--danger)">*</span></label>
                    <input type="text" id="title" name="title" class="FormGroup__input" placeholder="请输入帖子标题" required maxlength="100">
                    <div class="FormGroup__help">请使用简明扼要的标题，最多100个字符</div>
                </div>
                
                <div class="FormGroup">
                    <label for="content" class="FormGroup__label">内容 <span style="color: var(--danger)">*</span></label>
                    <div class="EditorToolbar">
                        <button type="button" class="EditorToolbar__button" title="加粗" onclick="insertFormat('strong')">
                            <i class="fa fa-bold"></i>
                        </button>
                        <button type="button" class="EditorToolbar__button" title="斜体" onclick="insertFormat('em')">
                            <i class="fa fa-italic"></i>
                        </button>
                        <button type="button" class="EditorToolbar__button" title="下划线" onclick="insertFormat('u')">
                            <i class="fa fa-underline"></i>
                        </button>
                        <div class="EditorToolbar__divider"></div>
                        <button type="button" class="EditorToolbar__button" title="插入链接" onclick="insertLink()">
                            <i class="fa fa-link"></i>
                        </button>
                        <button type="button" class="EditorToolbar__button" title="插入图片" onclick="document.getElementById('image-upload').click()">
                            <i class="fa fa-image"></i>
                        </button>
                        <div class="EditorToolbar__divider"></div>
                        <button type="button" class="EditorToolbar__button" title="插入引用" onclick="insertBlockquote()">
                            <i class="fa fa-quote-right"></i>
                        </button>
                        <button type="button" class="EditorToolbar__button" title="插入列表" onclick="insertList('ul')">
                            <i class="fa fa-list-ul"></i>
                        </button>
                        <button type="button" class="EditorToolbar__button" title="插入有序列表" onclick="insertList('ol')">
                            <i class="fa fa-list-ol"></i>
                        </button>
                    </div>
                    <textarea id="content" name="content" class="EditorContent" placeholder="请输入帖子内容" required></textarea>
                    <div class="FormGroup__help">支持基本的文本格式化，可以插入图片和链接</div>
                </div>
            </div>
            
            <div class="FormSection">
                <h3 class="FormSection__title">上传图片</h3>
                <div class="ImageUploader">
                    <input type="file" id="image-upload" class="ImageUploader__input" multiple accept="image/*">
                    <label for="image-upload" class="ImageUploader__label">
                        <div class="ImageUploader__icon">
                            <i class="fa fa-cloud-upload"></i>
                        </div>
                        <div class="ImageUploader__text">点击或拖拽图片到此处上传</div>
                        <div class="ImageUploader__help">支持 JPG、PNG、GIF 格式，单张不超过5MB，最多上传9张</div>
                    </label>
                </div>
                
                <div id="uploaded-images-container" class="UploadedImages">
                    <!-- 上传的图片将在这里显示 -->
                </div>
            </div>
            
            <div class="FormSection">
                <h3 class="FormSection__title">高级选项</h3>
                <div class="FormGroup">
                    <label class="FormGroup__label">
                        <input type="checkbox" name="anonymous" value="1">
                        <span style="margin-left: var(--gap-xs)">匿名发布</span>
                    </label>
                </div>
                <div class="FormGroup">
                    <label class="FormGroup__label">
                        <input type="checkbox" name="notify_reply" value="1" checked>
                        <span style="margin-left: var(--gap-xs)">接收回复通知</span>
                    </label>
                </div>
            </div>
            
            <div class="CreatePostForm__actions">
                <button type="button" class="CreatePostForm__cancel" onclick="window.history.back()">取消</button>
                <button type="submit" class="CreatePostForm__submit">发布帖子</button>
            </div>
        </form>
    </div>
</div>

<script>
    // 简单的富文本编辑功能
    function insertFormat(tag) {
        const textarea = document.getElementById('content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        if (selectedText) {
            const newText = `<${tag}>${selectedText}</${tag}>`;
            textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
            textarea.focus();
            textarea.setSelectionRange(start, start + newText.length);
        }
    }
    
    function insertLink() {
        const textarea = document.getElementById('content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        const url = prompt('请输入链接地址:', 'https://');
        if (url) {
            const text = selectedText || url;
            const newText = `<a href="${url}" target="_blank">${text}</a>`;
            textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
            textarea.focus();
        }
    }
    
    function insertBlockquote() {
        const textarea = document.getElementById('content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        const newText = `<blockquote>${selectedText || '引用内容'}</blockquote>`;
        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        textarea.focus();
    }
    
    function insertList(type) {
        const textarea = document.getElementById('content');
        const start = textarea.selectionStart;
        const end = textarea.selectionEnd;
        const selectedText = textarea.value.substring(start, end);
        
        let newText;
        if (selectedText) {
            const items = selectedText.split('\n').map(item => `<li>${item.trim()}</li>`).join('');
            newText = `<${type}>${items}</${type}>`;
        } else {
            newText = `<${type}><li>列表项1</li><li>列表项2</li></${type}>`;
        }
        
        textarea.value = textarea.value.substring(0, start) + newText + textarea.value.substring(end);
        textarea.focus();
    }
    
    // 图片上传预览
    document.getElementById('image-upload').addEventListener('change', function(e) {
        const files = e.target.files;
        const container = document.getElementById('uploaded-images-container');
        
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            
            // 检查文件类型
            if (!file.type.match('image.*')) {
                alert('请上传图片文件');
                continue;
            }
            
            // 检查文件大小
            if (file.size > 5 * 1024 * 1024) { // 5MB
                alert('图片大小不能超过5MB');
                continue;
            }
            
            // 限制上传数量
            if (container.children.length >= 9) {
                alert('最多只能上传9张图片');
                break;
            }
            
            const reader = new FileReader();
            reader.onload = function(event) {
                const imgItem = document.createElement('div');
                imgItem.className = 'UploadedImageItem';
                
                const img = document.createElement('img');
                img.src = event.target.result;
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'UploadedImageItem__remove';
                removeBtn.innerHTML = '<i class="fa fa-times"></i>';
                removeBtn.onclick = function() {
                    container.removeChild(imgItem);
                    // 这里可以添加移除已上传图片的逻辑
                };
                
                imgItem.appendChild(img);
                imgItem.appendChild(removeBtn);
                container.appendChild(imgItem);
            };
            
            reader.readAsDataURL(file);
        }
    });
    
    // 表单提交处理
    document.querySelector('.CreatePostForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const title = document.getElementById('title').value;
        const content = document.getElementById('content').value;
        
        if (!title.trim()) {
            alert('请输入帖子标题');
            return;
        }
        
        if (!content.trim()) {
            alert('请输入帖子内容');
            return;
        }
        
        // 这里是模拟表单提交，实际使用时会被后端处理
        const formData = new FormData(this);
        
        try {
            const response = await fetch('/api/forum/{{ forum.id }}/create-post', {
                method: 'POST',
                body: formData,
                credentials: 'same-origin'
            });
            
            const data = await response.json();
            if (data.success) {
                alert('帖子发布成功');
                window.location.href = `/post/${data.post_id}`;
            } else {
                alert(data.message || '帖子发布失败');
            }
        } catch (error) {
            console.error('提交失败:', error);
            alert('网络错误，请稍后重试');
        }
    });
</script>
{% endblock %}